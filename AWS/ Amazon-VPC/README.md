[Doc1](https://docs.aws.amazon.com/ko_kr/vpc/latest/userguide/what-is-amazon-vpc.html)
[Doc2](https://aws.amazon.com/ko/vpc/pricing/)

# Amazon VPC
- VPC (Virtual Private Cloud)는 클라우드 환경을 퍼블릭, 프라이빗의 논리적으로 독립된 네트워크 영역으로 분리하게 해줌.
- 논리적으로 분리된 영역에 격리할 수 있으며, 사용자가 네트워크 환경 설정에 대한 통제권을 가실 수 있음.
- 사용자가 Amazon VPC를 통해 만든 네트워크에서 자체 IP 주소, 퍼블릭, 프라이빗 서브넷, 라우트 테이블, 네트워크 게이트웨이 등 모든 기능을 활용할 수 있음.

### 활용 예시
- 애플리케이션 중 일부는 VPC 내 클라우드에서 실행, 일부는 온프레미스에서 실행.
- VPC 내에서 인터넷의 접근을 허용하는 퍼블릭 서브넷, 한정된 접근을 허용하는 프라이빗 서브넷 생성 가능.
- Direct Connect를 이용해 기업 데이터 센터와 VPN을 전용 회선으로 연결 할 수 있음.
- 하나 이상의 VPC가 필요하다면 다수의 VPC를 생성한 후 VPC 피어링을 통해 서로 연결 가능.

### Amazon VPC 구성요소 - 서브넷
![subnet](../Images/VPC.png "subnet")<br>

- 서브네트워크(subnetwork)의 줄임말로 IP 네트워크의 논리적인 영역을 부분적으로 나눈 하위 망을 말함.
- 서브넷을 통해 네트워크 분리 가능.

VPC(10.0.0.0/16) 내에 퍼블릭 서브넷, 프라이빗 서브넷
- VPC애에 서브넷을 통해 네트워크망을 분리
- VPC의 IP 대역인 10.0.0.0/16, 퍼블릭 서브넷, 프라이빗 서브넷의 IP 대역 10.0.0.0/24, 10.0.1.0/24

- VPC의 IP 대역을 10.0.0.0/16의 설정은 prefix가 /16이므로 앞의 10.0이 네트워크 주소를의미, 나머지 16bit로 호스트 주소를 정할 수 있다는 의미
  - 10.0.0.0 ~ 10.0.255.255 IP 범위가 같은 네트워크에 속한다는 의미
- 퍼블릭 서브넷의 IP 대역을 10.0.0.0/24로 설정시 24bit(10.0.0.)를 네트워크 주소로 사용하겠다는 의미, 나머지 8bit를 사용해서 호수트 주소를 정할 수 있다는 의미.
  - 10.0.0.0 ~ 10.0.0.255 IP 범위가 같은 퍼블릭 서브넷에 속한다는 의미
- 프라이빗 서브넷의 IP 대역을 10.0.1.0/24로 설정시 24bit(10.0.1.)를 네트워크 주소로 사용하겠다는 의미, 나머지 8bit를 사용해서 호수트 주소를 정할 수 있다는 의미.
  - 10.0.1.0 ~ 10.0.1.255 IP 범위가 같은 프라이 서브넷에 속한다는 의미

- 서브넷 IP 대역은 VPC의 IP 대역에 속해 있어야 하고, 서브넷은 1개의 가용 영역(AZ)에 종속되어야 함.
- AWS에서는 서브넷에 할당할 수 있는 IP 대역에서 미리 예약되어 있는 IP주소가 있는데 이런 예약된 IP 주소들은 AWS자원에 할당할 수 없음.

### AWS에서 서브넷 IP 대역마다 예약된 IP 주소
- 서브넷 IP 대역에서 1 ~ 4번째, 마지막 IP 주소는 예약이 되어 있음.
- ex) VPC의 IP 대역이 10.0.0.0/16, 해당 VPC에 존재하는 서브넷에 할당된 IP 대역이 10.0.0.0/24면 서브넷의 IP 대역은 10.0.0.0 ~ 10.0.0.255.
- 1번째 주소 : 10.0.0.0 -> 네트워크 주소
- 2번째 주소 : 10.0.0.1 -> AWS VPC 가상 라우터 주소
- 3번째 주소 : 10.0.0.2 -> AWS DNS 서버 주소
  - DNS 서버의 IP 주소는 해당 VPC의 IP 범위에 2를 더한 주소. CIDR 블록이 여러 개인 VPC (서브넷을 가지고 있는 VPC의 경우)<br>
    DNS 서버의 IP주소를 제외하고도 각 서브넷 IP 대역 범위에 2를 더한 모든 주소가 예약되어 있음.
- 4번째 주소 : 10.0.0.3 -> 향후 새로운 기능에 활용할 주소
- 마지막 주소 : 10.0.0.255 -> 네트워크 브로드캐스트 주소

### 퍼블릭 서브넷, 프라이빗 서브넷
- 퍼블릭 서브넷 : 공인 네트워크 개념. 외부 인터넷 구간과 직접적으로 통신을 할 수 있는 공공 네트워크.
- 프라이빗 서브넷 : 사설 네트워크 개념. 외부 인터넷 구간과 직접적인 통신을 할 수 없는 폐쇄적인 네트어ㅜ크 망.
- VPC 이용시 [퍼블릭 서브넷, 프라이빗 서브넷, VPN only 서브넷]등 필요에 따라 다양한 서브넷 생성 가능.
  - 퍼블릭 서브넷 : 인터넷을 통해 연결할 수 있는 리소스를 배치하기 위한 네트워크
  - 프라이빗 서브넷 : 인터넷으로 연결하지 않고 보안 유지를 위한 배타적인 연결에 사용되는 네트워크
  - VPN Only 서브넷 : 기업의 데이터 센터와 VPC를 연결하는 데 사용되는 네트워크
- ex) 3티어 구조시 웹은 퍼블릭 서브넷, DB 티어는 프라이빗 서브넷에 위치가 적합.


### Amazon VPC 구성요소 - 가상 라우터와 라우트 테이블
- VPC를 생성하면 자동으로 가상 라우터가 생성.
- 이 가상 라우터는 라우트 테이블을 가지고 있는데, 라우트 테이블은 트래픽의 전송 방향을 결정하는 라우트와 관련된 규칙을 담는 테이블
- 목적지를 향한 최적의 경로로 데이터 패킷을 전송하기 위한 모든 정보를 담고 있음.
- 가상 라우터: 최초에 기본 라우트 테이블을 보유. 로컬 네트워크에 대한 라우트 경로만 설정되어 있음.
- 로컬 네트워크 : VPC의 자체 IP 대역. VPC 내에 생성된 서브넷은 라우트 테이블의 로컬 네트워크에 의해 통신 가능.
- 가상 라우터에서는 서브넷별로 라우트 테이블을 생성하고 매핑하여 서브넷 당 개별적인 라우트 테이블을 가질 수 있음.

#### 퍼블릭 서브넷 매핑 라우트 테이블
- Destination(10.0.0.0/16)은 10.0.0.0 ~ 10.0.0.255.255 까지의 트래픽을 Target(local)로 보내고 다른 모든 대역들(0.0.0.0/0, ::/0)의 트래픽은
  Target(Internet Gate Way)로 보내라는 정보가 저장되어 있음.
- 만약 10.0.0.1 안에 서버에서 10.0.0.2로 트래픽을 보내면, 라우트 테이블을 거쳐 로컬로 보내지게 됨.

#### 프라이빗 서브넷 매핑 라우트 테이블
- 프라이빗 서브넷이 매핑된 라우트 테이블은 인터넷 게이트웨이(IGW) 설정이 없기 때문에, 해당 서브넷과 연결된 서버로는 인터넷에 접근할 수 없다.
- Destination(10.0.0.0/16) 10.0.0.0 ~ 10.0.255.255 까지의 트래픽을 Target(local)로 보내는 것은 동일.
<br>

![Routetable](../Images/Routetable.png "Routetable")<br>
- VPC(10.0.0.0/16)을 퍼블릭 서브넷(10.0.0.0/24), 프라이빗 서브넷(10.0.1.0/24)로 나누고 각각 라우트 테이블을 생성해 매핑한 표.
- 퍼블릭 라우트 테이블은 10.0.0.0/16의 트래픽만 로컬로 보내주는 설정 뿐.
- 때문에 퍼블릭 서브넷에 위치한 서버가 인터넷으로 트래픽을 보낼 수 없는 구조.
- 여기서, 인터넷에 연결하기 위해서는 인터넷 게이트웨이(IGW)가 필요 함.


### Amazon VPC 구성요소 - 인터넷 게이트웨이 (IGW)
- 인터넷 게이트웨이(IGW)는 VPC와 인터넷 간의 논리적인 연결. 간략하게 VPC에서 인터넷으로 나가는 관문.
- 인터넷 게이트웨이는 VPC 당 1개만 연결 가능.
- IGW를 통해 외부 인터넷으로 통신할 수 잇는 대상은 퍼블릭 서브넷 뿐.
- 이런 퍼블릭 서브넷은 자신의 라우트 테이블에 외부 인터넷으로 나가는 Target을 IGW로 지정해야 함.
- IGW는 양방향으로 연결을 지원하기 때문에 외부 인터넷에서 퍼블릭 서브넷의 퍼블릭 IP로도 정상적인 통신이 가능.

- 퍼블릭 서브넷 통신 흐름
  - 퍼블릭 서브넷에 위치한 EC2 인스턴스는 사설 IP를 사용해 VPC의 가상 라우터로 트래픽을 전달.
  - 가상 라우터는 퍼블릭 라우트 테이블을 참조하여 기본 경로(0.0.0.0/0)가 인터넷 게이트웨이로 설정된 경우 해당 트래픽을 인터넷 게이트웨이로 전달
  - 인터넷 게이트웨이는 EC2의 사설 IP를 매핑된 퍼블릭 IP로 NAT 변환하여 인터넷 구간으로 전송.
  - 외부에서 퍼블릭 IP로 유입된 트래픽은 인터넷 게이트웨이에서 다시 사설 IP로 변환되어 퍼블릭 서브넷의 EC2 인스턴스로 전달.
  - 보안 그룹, 네트워크 ACL이 허용된 경우 정상적인 통신이 이뤄짐.


### Amazon VPC 구성요소 - NAT Gateway
- 인터넷 게이트웨이처럼 외부 인터넷과 연결하는 관문 역할.
- 프라이빗 리소스를 대신해 나가주는 중계자
- 인바운드 불가능, 아웃바운드 가능.
- 인터넷은 공공 네트워크 구간으로 퍼블릭 IP를 통해 통신이 이뤄짐.
- so 프라이빗 IP로는 인터넷에 접근할 수 없는데, NAT 게이트웨이가 프라이빗 IP를 퍼블릭 IP로 변환하여 통신을 도울 수 있음.
- 외부에서의 접근은 막고, 서브넷 내에 배치된 자원이 외부에서 패키지를 설치받는 경우에 인터넷에 접근이 필요함. 이럴 때 사용

- 프라이빗 서브넷 통신 흐름
  - 프라이빗 서브넷에 위치한 EC2 인스턴스는 사설 IP를 사용하여 외부 인터넷과 통신하기 위해 VPC 가상 라우터로 트래픽을 전달.
  - 가상 라우터는 프라이빗 서브넷에 매핑된 라우트 테이블을 참조하여 기본 경로가 NAT Gateway로 설정된 경우 해당 트래픽을 전달.
  - NAT Gateway는 EC2 인스턴스의 사설 IP를 퍼블릭 IP로 변환한 뒤 인터넷 게이트웨이를 통해 외부 인터넷 서버로 요청을 전송.
  - 외부 서버의 응답 트래픽은 NAT Gateway에서 다시 사설 IP로 변환되어 프라이빗 서브넷의 EC2 인스턴스로 전달.
 
### Amazon VPC 구성 요소 - NACL, Security Group
- VPC에서는 인스턴스 레벨, 서브넷 레벨에서 대상을 필터링 할 수 있는 보안 기술을 사용할 수 있다.
- 인스턴스 레벨의 보안 기술은 보안그룹(Security Group), 서브넷 레벨에서의 보안 기술은 NACL(Network Access Control List).
- 인바운드, 아웃바운드되는 데이터에 대해 허용 규칙, 거부 규칙을 수립하여, 원하는 요청만 수용할 수 있게 보안을 강화.

#### 접근 제어(Access Control)
- 보안상 위협으로부터 환경을 보호하기 위한 보안 정책으로 인가된 대상은 접근에 허용하고, 인가되지 않은 대상은 접근을 거부해 보안을 강화.
- 접근 제어 절차는 식별(Identity), 인증(Authentication), 권한(Authorization) 수너로 진행.
- 먼저 대상을 식별하는 작업이 선행, 일반적으로 IP 주소를 통해 대상을 식별하거나 프로토콜과 포트 번호를 통해 서비스를 식별할 수 있음.
- 이후 식별된 대상에 대한 인증을 수행하여 적합한 대상인지 판단, 정책에 따라 허용, 거부, 제한적인 허용 등의 권한을 부여해 접근에 대한 제어를 수행.

#### 보안 그룹, 네트워크 ACL
- AWS에서 네트워크 인프라 보호를 위해서 인스턴스 레벨과 서브넷 레벨에서 접근 제어(Access Control) 역할을 해주는 것이 보안 그룹과 네트워크 ACL.
- 보안 그룹(Security Group)과 네트워크 ACL(Network Access Control List)은 IP 주소와 프로토콜 그리고 포트 번호를 통해 대상을 식별하고 제어 정책에 따라 대상의 허용 여부를 판단.
- 이런 보안 그룹과 네트워크 ACL은 트래픽의 방향성에 따라 인바운드 규칙(Inbound Rule)과 아웃바운드 규칙(Outbound Rule)으로 나뉨. 
- 여기서 방향의 기준은 AWS 인프라 입장이기 때문에 외부 대상(User)에서 AWS 인프라로 들어오는 방향을 인바운드 규칙, AWS 인프라에서 외부 대상으로 나가는 방향을 아웃바운드 규칙이라 함.

##### Security Group (보안 그룹)
- 트래픽 제어 대상이 인스턴스 레벨(EC2, Application Load Balancer.. 등).
- 보안 그룹은 Stateful하므로, 이전 상태 정보를 기억하고 있다가 다음 단계에서 그 상태 정보를 활용할 수 있다.
- 인바운드로 들어오는 트래픽에 대해 인바운드 규칙 확인후 대상의 인스턴스 접근이 허용 된다면, 그 상태 정보를 기억하고 있어서 아웃바운드로 되돌아갈 때(return traffic) 아웃바운드 규칙과 상관 없이 허용됨. 
- 즉, 보안 그룹은 허용 규칙만 존재하며 그 대상이 아닌 트래픽은 자동으로 거부된다.

##### 네트워크 ACL
- 트래픽 제어 대상이 VPC 내부에 생성한 서브넷 레벨.
- 네트워크 ALC은 Stateless해. 네트워크 ACL이 이전 상태 정보를 기억하지 않아 다음 단계에 관여하지 않는다.
- 인바운드로 들어오는 트래픽에 대해 인바운드 규칙 확인 후에 대상이 허용된다고 해도 그 상태 정보를 기억하고 있지 않기 때문에 아웃바운드로 되돌아갈 때 아웃바운드 규칙에 따라 허용할지 거부할지를 결정한다. 
- 즉, 허용 규칙과 거부 규칙이 둘 다 존재한다.
